{
  "version": 3,
  "sources": ["../../shared/src/index.ts", "../src/effect.ts", "../src/handler.ts", "../src/reactive.ts"],
  "sourcesContent": ["export const isObject=(value)=>{\n  return value!=null &&typeof value==='object'\n}", "export let activeEffect=undefined\n\nfunction cleanupEffect(effect){\n  const {deps}=effect\n\n  for(let i = 0;i<deps.length;i++){\n    // \u627E\u5230set \u8BA9set\u79FB\u9664\u6389\u81EA\u5DF1\n    deps[i].delete(effect)\n  }\n\n  effect.deps.length=0;//\u6E05\u7A7A\u4F9D\u8D56\u7684\u5217\u8868\n\n}\n\n\nexport class ReactiveEffect{\n  // \u9ED8\u8BA4\u4F1A\u5C06fn\u6302\u8F7D\u5230\u6765\u7684\u5B9E\u4F8B\u4E0A\n  constructor(private fn){\n\n  }\n\n  parent=undefined\n  deps=[];//\u6211\u4F9D\u8D56\u4E86\u54EA\u4E9B\u5C5E\u6027\n\n  active=true\n\n  run(){\n    // \u5931\u6D3B\u6001\u9ED8\u8BA4\u8C03\u7528run\u7684\u65F6\u5019  \u53EA\u662F\u91CD\u65B0\u6267\u884C\n    // \u4E0D\u4F1A\u53D1\u751F\u4F9D\u8D56\u6536\u96C6\n    if(!this.active){\n      return this.fn()\n    }\n    try{\n      this.parent=activeEffect\n      activeEffect=this\n\n      cleanupEffect(this)\n\n      return this.fn()//fn()\u4F1A\u89E6\u53D1\u4F9D\u8D56\u6536\u96C6\n    }finally{\n      activeEffect=this.parent\n      this.parent=undefined\n    }\n  }\n\n  stop(){\n    if(this.active){\n      // \u5931\u6D3B\u7684\u610F\u601D\u5C31\u662F\u505C\u6B62\u4F9D\u8D56\u6536\u96C6\n       this.active=false\n       cleanupEffect(this)\n    }\n  }\n}\n\n\nexport function effect(fn){\n  // \u521B\u5EFA\u4E00\u4E2A\u54CD\u5E94\u5F0Feffect  \u5E76\u4E14\u8BA9effect\u6267\u884C\n  const _effect=new ReactiveEffect(fn)\n  _effect.run()\n\n  // \u628Arunner\u65B9\u6CD5\u76F4\u63A5\u7ED9\u7528\u6237  \u7528\u6237\u53EF\u4EE5\u53BB\u8C03\u7528effect\u4E2D\u5B9A\u4E49\u7684\u5185\u5BB9\n  const runner=_effect.run.bind(_effect)\n  // \u53EF\u4EE5\u901A\u8FC7runner \u62FF\u5230effect\u4E2D\u6240\u6709\u5C5E\u6027\n  runner.effect=_effect\n\n  return runner\n}\n\n\n\nconst targetMap=new WeakMap()\nexport function track(target,key){\n  // \u8BA9\u8FD9\u4E2A\u5BF9\u8C61\u4E0A\u7684\u5C5E\u6027  \u8BB0\u5F55\u5F53\u524D\u7684activeEffect\n\n  if(activeEffect){\n    // \u8BF4\u660E\u7528\u6237\u5728effect\u4E2D\u4F7F\u7528\u7684\u8FD9\u4E2A\u6570\u636E\n    let depsMap=targetMap.get(target)\n\n    // \u5982\u679C\u6CA1\u6709\u521B\u5EFA\u4E00\u4E2A\u6620\u5C04\u8868\n    if(!depsMap){\n      targetMap.set(target,(\n        depsMap=new Map()\n      ))\n    }\n\n    // \u5982\u679C\u6709\u8FD9\u4E2A\u6620\u5C04\u8868\u6765\u67E5\u627E\u4E00\u4E0B\u6709\u6CA1\u6709\u8FD9\u4E2A\u5C5E\u6027\n    let dep=depsMap.get(key);\n    if(!dep){\n      depsMap.set(key,(dep=new Set()))\n    }\n\n    // \u5982\u679C\u6709\u5219\u770B\u4E00\u4E0Bset\u4E2D\u6709\u6CA1\u6709\u8FD9\u4E2Aeffect\n    let shouldTrack=!dep.has(activeEffect)\n    if(shouldTrack){\n      dep.add(activeEffect)\n\n      // name = new Set(effect)\n      // age = new Set(effect)\n\n      // \u6211\u53EF\u4EE5\u901A\u8FC7\u5F53\u524D\u7684effect \u627E\u5230\u8FD9\u4E24\u4E2A\u96C6\u5408\u4E2D\u7684\u81EA\u5DF1  \u5C06\u5176\u79FB\u9664\u6389\u5C31\u53EF\u4EE5\u4E86\n\n\n\n      activeEffect.deps.push(dep)\n    }\n  }\n\n}\n\n\nexport function trigger(target,key,value,oldValue){\n  // \u901A\u8FC7\u5BF9\u8C61\u627E\u5230\u5BF9\u5E94\u7684\u5C5E\u6027  \u8BA9\u8FD9\u4E2A\u5C5E\u6027\u5BF9\u5E94\u7684effect\u91CD\u65B0\u6267\u884C\n  const depsMap=targetMap.get(target)\n\n  if(!depsMap){\n    return\n  }\n\n  const dep=depsMap.get(key);//name \u6216\u8005 age \u5BF9\u5E94\u6240\u6709\u7684effect\n\n  const effects=[...dep]\n\n  effects&&effects.forEach(effect => {\n    // \u6B63\u5728\u6267\u884C\u7684effect \u4E0D\u8981\u591A\u6B21\u6267\u884C\n    if(effect!==activeEffect) effect.run()\n  });\n\n\n}", "import { ReactiveFlags } from './reactive'\nimport {track,trigger} from './effect'\n\nexport const mutableHandlers={\n    get(target,key,receiver){\n      // \u53D6\u503C\u7684\u65F6\u5019\n      // \u6211\u4EEC\u5728\u4F7F\u7528proxy\u7684\u65F6\u5019\u8981\u642D\u914Dreflect\u6765\u4F7F\u7528  \u7528\u6765\u89E3\u51B3this\u95EE\u9898\n      if(key==ReactiveFlags.IS_REACTIVE){\n        return true\n      }\n\n\n      // \u505A\u4F9D\u8D56\u6536\u96C6  \u8BB0\u5F55\u5C5E\u6027\u548C\u5F53\u524Deffect\u7684\u5173\u7CFB\n      const res=Reflect.get(target,key,receiver)\n      track(target,key)\n\n      return res\n    },\n    set(target,key,value,receiver){\n      // \u66F4\u65B0\u6570\u636E\n\n      // \u627E\u5230\u8FD9\u4E2A\u6570\u5B57\u5BF9\u5E94\u7684effect\u8BA9\u4ED6\u6267\u884C\n      let oldValue=target[key]\n\n      const r=Reflect.set(target,key,value,receiver)\n\n      if(oldValue!==value){\n        trigger(target,key,value,oldValue)\n      }\n     \n      return r\n    }\n  }", "import { isObject } from '@vue/shared';\nimport { mutableHandlers } from './handler';\n\nexport enum ReactiveFlags {\n  IS_REACTIVE='__v_isReactive'\n}\n\nconst reactiveMap=new WeakMap()\nexport function reactive(target){\n  // reactive \u53EA\u80FD\u5904\u7406\u5BF9\u8C61\u7C7B\u578B\u7684\u6570\u636E  \u4E0D\u662F\u5BF9\u8C61\u4E0D\u5904\u7406\n  if(!isObject(target)) return target\n\n  // \u7F13\u5B58\u53EF\u4EE5\u91C7\u7528\u6620\u5C04\u8868  {{target}->proxy}\n\n  let existingProxy=reactiveMap.get(target)\n\n  if(existingProxy) return existingProxy\n\n  if(target[ReactiveFlags.IS_REACTIVE]){\n    return target\n  }\n\n\n  const proxy=new Proxy(target,mutableHandlers)\n\n  reactiveMap.set(target,proxy)\n\n  return proxy\n\n}"],
  "mappings": "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",
  "names": ["effect", "ReactiveFlags"]
}
