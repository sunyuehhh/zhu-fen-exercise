{"version":3,"file":"index.js","sources":["../src/CacheContext.js","../src/cache-types.js","../src/cacheReducer.js","../src/KeepAliveProvider.js","../src/withKeepAlive.js"],"sourcesContent":["import React from 'react';\r\nconst CacheContext = React.createContext();\r\nexport default CacheContext;","export const CREATE = 'CREATE';        //创建\r\nexport const CREATED = 'CREATED';      //创建成功\r\nexport const ACTIVE = 'ACTIVE';        //激活\r\nexport const DESTROY = 'DESTROY'; //销毁","import *  as cacheTypes from './cache-types';\r\nfunction cacheReducer(cacheStates = {}, { type, payload }) {\r\n    switch (type) {\r\n        case cacheTypes.CREATE:\r\n            return { ...cacheStates,\r\n                [payload.cacheId]: {\r\n                    scrolls:{},\r\n                    cacheId:payload.cacheId,\r\n                    element:payload.element,\r\n                    status:cacheTypes.CREATE\r\n                } };\r\n        case cacheTypes.CREATED:\r\n            return { ...cacheStates,\r\n                [payload.cacheId]: {\r\n                    ...cacheStates[payload.cacheId],\r\n                    doms:payload.doms,\r\n                    status:cacheTypes.CREATED\r\n                } };   \r\n        case cacheTypes.ACTIVE:\r\n            return { ...cacheStates,\r\n                [payload.cacheId]: {\r\n                    ...cacheStates[payload.cacheId],\r\n                    status:cacheTypes.ACTIVE\r\n                } };           \r\n        case cacheTypes.DESTROY:\r\n            return { ...cacheStates,\r\n                [payload.cacheId]:{\r\n                    ...cacheStates[payload.cacheId],\r\n                    status:cacheTypes.DESTROY\r\n                }};              \r\n        default:\r\n            return cacheStates;\r\n    }\r\n}\r\nexport default cacheReducer;","import React, { useReducer, useCallback } from \"react\";\r\nimport CacheContext from './CacheContext';\r\nimport cacheReducer from './cacheReducer';\r\nimport * as cacheTypes from './cache-types';\r\nfunction KeepAliveProvider(props) {\r\n    let [cacheStates, dispatch] = useReducer(cacheReducer, {});\r\n    const mount = useCallback(({ cacheId, element }) => {\r\n       if(cacheStates[cacheId]){\r\n           let cacheState = cacheStates[cacheId];\r\n           if(cacheState.status === cacheTypes.DESTROY){\r\n               let doms = cacheState.doms;\r\n               doms.forEach(dom=>dom.parentNode.removeChild(dom));\r\n               dispatch({ type: cacheTypes.CREATE, payload: { cacheId, element } });\r\n           }\r\n       }else{\r\n           dispatch({ type: cacheTypes.CREATE, payload: { cacheId, element } });\r\n       }\r\n    }, [cacheStates]);\r\n    let handleScroll = useCallback((cacheId, {target}) => {\r\n        if(cacheStates[cacheId]){\r\n            let scrolls = cacheStates[cacheId].scrolls;\r\n            scrolls[target] = target.scrollTop;\r\n        }\r\n    }, [cacheStates]);\r\n    return (\r\n        <CacheContext.Provider value={{ mount, cacheStates, dispatch,handleScroll }}>\r\n            {props.children}\r\n            {Object.values(cacheStates).filter(cacheState=>cacheState.status!==cacheTypes.DESTROY).map(({ cacheId, element }) => (\r\n                <div\r\n                    id={`cache_${cacheId}`}\r\n                    key={cacheId}\r\n                    ref={(dom) => {\r\n                        let cacheState = cacheStates[cacheId];\r\n                        if (dom && (!cacheState.doms || cacheState.status === cacheTypes.DESTROY) ) {\r\n                            let doms = Array.from(dom.childNodes);\r\n                            dispatch({ type: cacheTypes.CREATED, payload: { cacheId, doms } });\r\n                        }\r\n                    }}\r\n                >{element}</div>\r\n            ))}\r\n        </CacheContext.Provider>\r\n    );\r\n}\r\nexport default KeepAliveProvider;","import React, { useContext, useRef,useEffect } from \"react\";\r\nimport CacheContext from './CacheContext';\r\nimport * as cacheTypes from './cache-types';\r\nfunction withKeepAlive(OldComponent, { cacheId = window.location.pathname,scroll=false }) {\r\n    return function (props) {\r\n        const {mount, cacheStates,dispatch,handleScroll } = useContext(CacheContext);\r\n        const ref = useRef(null);\r\n        useEffect(()=>{\r\n            if(scroll){\r\n                ref.current.addEventListener('scroll', handleScroll.bind(null, cacheId),true);\r\n            }\r\n        },[handleScroll]);\r\n        useEffect(() => {\r\n            let cacheState = cacheStates[cacheId];\r\n            if(cacheState&&cacheState.doms && cacheState.status !== cacheTypes.DESTROY){\r\n                let doms = cacheState.doms;\r\n                doms.forEach(dom=>ref.current.appendChild(dom));\r\n                if(scroll){\r\n                   doms.forEach(dom=>{\r\n                       if (cacheState.scrolls[dom])\r\n                         dom.scrollTop = cacheState.scrolls[dom];\r\n                   });\r\n                  }\r\n            }else{\r\n                mount({ cacheId, element: <OldComponent {...props} dispatch={dispatch}/> })\r\n            }\r\n        }, [cacheStates, dispatch, mount, props]);\r\n        return <div id={`keepalive_${cacheId}`} ref={ref} />;\r\n    }\r\n}\r\nexport default withKeepAlive;"],"names":["CacheContext","React","createContext","CREATE","CREATED","ACTIVE","DESTROY","cacheReducer","cacheStates","type","payload","cacheTypes","cacheId","scrolls","element","status","doms","KeepAliveProvider","props","useReducer","dispatch","mount","useCallback","cacheState","forEach","dom","parentNode","removeChild","handleScroll","target","scrollTop","children","Object","values","filter","map","Array","from","childNodes","withKeepAlive","OldComponent","window","location","pathname","scroll","useContext","ref","useRef","useEffect","current","addEventListener","bind","appendChild"],"mappings":"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"}